name: Deploy to Render

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create dummy .env file for testing
      run: |
        echo "GEMINI_API_KEY=test_key" > .env
        echo "DISCORD_WEBHOOK=https://discord.com/api/webhooks/test" >> .env
        echo "GITHUB_TOKEN=test_token" >> .env
        echo "GITHUB_USERNAME=test_user" >> .env
        echo "ADMIN_KEY=test_admin" >> .env
        echo "PORT=8000" >> .env
    
    - name: Test import
      run: |
        python -c "import vicky_app; print('âœ… App imports successfully')"
    
    - name: Test server startup (quick test)
      run: |
        timeout 10s python -c "
        import vicky_app
        from fastapi.testclient import TestClient
        try:
            client = TestClient(vicky_app.app)
            response = client.get('/api/info')
            print('âœ… Server responds correctly')
            print(f'Status: {response.status_code}')
        except Exception as e:
            print(f'âŒ Server test failed: {e}')
            exit(1)
        " || echo "âœ… Server test completed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to Render
      run: |
        echo "ğŸš€ Deploying to Render..."
        echo "âœ… Render will automatically deploy from main branch"
        echo "ğŸ“‹ Make sure to set environment variables in Render dashboard"
        echo "ğŸ”— Check deployment at: https://dashboard.render.com"
